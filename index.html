<!DOCTYPE html>
<html lang="lb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>P4 – Verben (Spiller)</title>

  <style>
    /* FONT */
    @font-face{
      font-family:'Schoulschrëft';
      src:url('https://raw.githubusercontent.com/albrechtclaire1007/schoulschreft/main/schoulschreft_bold%5B2%5D.TTF')
           format('truetype');
      font-weight:bold;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --purple-mid:#b7a2e5;
      --purple-light:#ebe3ff;
      --purple-dark:#6c4aa3;
      --ink:#2d1844;
      --white:#fff;
      --ok:#b7f0c8;
      --bad:#ffcccc;

      /* Inversion colours (match your grammar sheet vibe) */
      --inv-person:#d9edff; /* light blue */
      --inv-verb:#e6dcff;   /* light purple */
      --inv-gar:#ffd9c4;    /* peach */
      --inv-info:#dbefff;   /* blue */
    }

    *{ margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:'Schoulschrëft', system-ui, sans-serif;
      background:var(--purple-light);
      padding:16px;
      color:var(--ink);
      min-height:100vh;
    }

    button, input, select{
      font-family:'Schoulschrëft', system-ui, sans-serif;
      cursor:pointer;
    }

    /* TOP BAR */
    .top-bar{
      max-width:1100px;
      margin:0 auto 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:var(--purple-mid);
      border-radius:999px;
      padding:6px 12px;
      color:var(--white);
      gap:10px;
    }
    .top-bar-title{
      font-size:1.55rem;
      flex:1;
      text-align:center;
      min-height:1.4em;
      opacity:.95;
    }
    .top-arrow{
      width:38px;
      height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      border:2px solid var(--white);
      font-size:1.7rem;
      background:transparent;
      color:var(--white);
    }

    .subtitle{
      max-width:1100px;
      margin:0 auto 14px;
      text-align:center;
      font-size:1.25rem;
      opacity:0.85;
    }

    .games{
      max-width:1100px;
      margin:0 auto;
    }

    .game{ display:none; }
    .game.active{ display:block; }

    h2{
      font-size:1.55rem;
      margin-bottom:8px;
      text-align:center;
      color:var(--purple-dark);
    }

    .instruction-box{
      background:var(--white);
      border-radius:18px;
      padding:12px 16px;
      text-align:center;
      font-size:1.35rem;
      margin:0 auto 14px;
      border:2px solid rgba(108,74,163,.15);
    }

    .row-center{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin: 0 auto 14px;
    }

    .primary{
      padding:10px 18px;
      border-radius:999px;
      border:2px solid var(--purple-dark);
      background:var(--purple-mid);
      color:var(--white);
      font-size:1.25rem;
    }
    .secondary{
      padding:8px 14px;
      border-radius:999px;
      border:2px solid var(--purple-mid);
      background:white;
      color:var(--ink);
      font-size:1.15rem;
    }
    .pill{
      background:var(--white);
      border-radius:999px;
      padding:8px 14px;
      border:2px solid rgba(108,74,163,.15);
      font-size:1.2rem;
    }

    .feedback{
      margin-top:10px;
      min-height:1.4em;
      font-size:1.35rem;
      text-align:center;
    }
    .feedback.ok{ color:#117a3a; }
    .feedback.bad{ color:#b02323; }

    /* ===== Prompt box ===== */
    .big-box{
      width:min(860px, 100%);
      background:var(--white);
      border-radius:18px;
      padding:18px 18px;
      border:2px solid rgba(108,74,163,.15);
      text-align:center;
      margin: 0 auto;
    }

    /* single prompt line: "spillen, du" */
    .promptLine{
      font-size:2.75rem;
      color:var(--purple-dark);
      line-height:1.1;
    }

    /* ===== Choice buttons ===== */
    .choices{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin: 14px auto 0;
    }
    .choice{
      padding:12px 16px;
      border-radius:16px;
      border:2px solid rgba(108,74,163,.18);
      background:var(--white);
      font-size:1.35rem;
      min-width: 210px;
    }
    .choice:active{ transform: scale(.98); }

    .flash-green{ animation: flashGreen .25s ease; }
    .flash-red{ animation: flashRed .25s ease; }
    @keyframes flashGreen{
      0%{ box-shadow:none; }
      50%{ box-shadow: 0 0 0 6px rgba(183,240,200,.95); }
      100%{ box-shadow:none; }
    }
    @keyframes flashRed{
      0%{ box-shadow:none; }
      50%{ box-shadow: 0 0 0 6px rgba(255,204,204,.95); }
      100%{ box-shadow:none; }
    }

    /* ===== Mini table ===== */
    table{
      width: min(860px, 100%);
      margin: 0 auto;
      border-collapse: collapse;
      background: var(--white);
      border-radius:18px;
      overflow:hidden;
      border:2px solid rgba(108,74,163,.15);
    }
    td, th{
      border:1px solid rgba(108,74,163,.18);
      padding:12px;
      text-align:center;
      font-size:1.35rem;
    }
    th{
      background: rgba(183,162,229,.35);
      color: var(--ink);
    }
    .cell-green{
      background: rgba(183,240,200,.55);
    }
    .cell-red{
      background: rgba(255,204,204,.35);
    }
    select{
      padding:8px 10px;
      border-radius:12px;
      border:2px solid rgba(108,74,163,.18);
      background: #fff;
      font-size:1.25rem;
    }

    /* ===== Build from parts ===== */
    .parts{
      width:min(900px, 100%);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .partsRow{
      background: var(--white);
      border-radius:18px;
      border:2px solid rgba(108,74,163,.15);
      padding:12px;
    }
    .partsRowTitle{
      text-align:center;
      opacity:.85;
      margin-bottom:10px;
      font-size:1.25rem;
    }
    .tiles{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .tile{
      background: var(--purple-light);
      border:2px solid rgba(108,74,163,.12);
      border-radius:14px;
      padding:10px 14px;
      font-size:1.55rem;
      user-select:none;
      cursor:pointer;
    }
    .tile.selected{
      outline:3px solid rgba(108,74,163,.25);
      outline-offset:2px;
    }
    .resultBox{
      width:min(860px, 100%);
      margin: 12px auto 0;
      background: var(--white);
      border-radius:18px;
      border:2px solid rgba(108,74,163,.15);
      padding:14px;
      text-align:center;
      font-size:2.0rem;
    }

    /* ===== Inversion game ===== */
    .drag-bank{
      width:min(980px, 100%);
      margin: 0 auto 14px;
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:10px;
    }
    .drag{
      padding:12px 16px;
      border-radius:18px;
      font-size:1.35rem;
      border:2px solid rgba(0,0,0,.08);
      user-select:none;
      cursor:grab;
    }
    .drag:active{ transform:scale(.98); }
    .drag.verb{ background:var(--inv-verb); }
    .drag.person{ background:var(--inv-person); }
    .drag.gar{ background:var(--inv-gar); }
    .drag.info{ background:var(--inv-info); }

    .inv-zones{
      width:min(980px, 100%);
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .inv-slot{
      background:var(--white);
      border-radius:18px;
      border:2px dashed rgba(108,74,163,.45);
      min-height:72px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.45rem;
      text-align:center;
      padding:8px;
    }
    .inv-slot.over{
      outline:4px solid rgba(108,74,163,.18);
      outline-offset:2px;
    }
    .inv-slot.filled{
      border-style:solid;
    }

    .inv-chip{
      border-radius:14px;
      padding:10px 12px;
      display:inline-block;
    }
    .inv-chip.verb{ background:var(--inv-verb); }
    .inv-chip.person{ background:var(--inv-person); }
    .inv-chip.gar{ background:var(--inv-gar); }
    .inv-chip.info{ background:var(--inv-info); }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(45,24,68,.25);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .overlay.show{ display:flex; }
    .modal{
      background:var(--white);
      border-radius:18px;
      border:2px solid rgba(108,74,163,.18);
      width:min(520px, 100%);
      padding:16px;
      text-align:center;
    }
    .modal h3{
      color:var(--purple-dark);
      font-size:1.9rem;
      margin-bottom:8px;
    }
    .modal p{
      font-size:1.35rem;
      margin-bottom:12px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <button class="top-arrow" id="prevBtn" aria-label="Viregt Spill">‹</button>
    <div class="top-bar-title" id="topTitle"></div>
    <button class="top-arrow" id="nextBtn" aria-label="Nächst Spill">›</button>
  </div>

  <div class="subtitle">P4 – Verben (Konjugéieren)</div>

  <div class="games">

    <!-- G1 Oral -->
    <section class="game active" id="g1">
      <h2>Konjugéieren (mëndlech)</h2>
      <div class="instruction-box">Kuck d’Form a konjugéier (mëndlech). Keng Kontroll.</div>
      <div class="row-center">
        <button class="primary" id="g1Next">Nächst</button>
        <button class="secondary" id="g1Mix">Nei mixen</button>
        <div class="pill" id="g1Prog">1 / 105</div>
      </div>
      <div class="big-box">
        <div class="promptLine" id="g1Prompt">spillen, du</div>
      </div>
    </section>

    <!-- G2: Build from parts -->
    <section class="game" id="g9">
      <h2>Bauen: Stamm + Endung</h2>
      <div class="instruction-box">Wiel e Stamm an eng Endung. Du kanns probéieren (och falsch).</div>
      <div class="row-center">
        <button class="secondary" id="g9Mix">Nei mixen</button>
        <button class="primary" id="g9Check">Kontrolléieren</button>
        <div class="pill" id="g9Prog">1 / …</div>
      </div>

      <div class="big-box">
        <div class="promptLine" id="g9Prompt">spillen, du</div>
      </div>

      <div class="parts">
        <div class="partsRow">
          <div class="partsRowTitle">Stamm</div>
          <div class="tiles" id="g9Stems"></div>
        </div>
        <div class="partsRow">
          <div class="partsRowTitle">Endung</div>
          <div class="tiles" id="g9Ends"></div>
        </div>
      </div>

      <div class="resultBox" id="g9Result">—</div>
      <div class="feedback" id="g9Fb"></div>
    </section>

    <!-- G3: Change type -->
    <section class="game" id="g2">
      <h2>Stamm, Endung, Näischt, déi zwee</h2>
      <div class="instruction-box">Hei steet schonn d’konjugéiert Form. Wat ännert sech am Verglach mam Infinitiv?</div>
      <div class="row-center">
        <button class="secondary" id="g2Mix">Nei mixen</button>
        <div class="pill" id="g2Prog">1 / …</div>
      </div>
      <div class="big-box" id="g2Box">
        <div class="promptLine" id="g2Prompt">fueren → fiers</div>
        <div class="choices">
          <button class="choice" id="g2Stem">Stamm</button>
          <button class="choice" id="g2End">Endung</button>
          <button class="choice" id="g2None">Näischt</button>
          <button class="choice" id="g2Both">déi zwee</button>
        </div>
      </div>
      <div class="feedback" id="g2Fb"></div>
    </section>

    <!-- G4: MCQ -->
    <section class="game" id="g3">
      <h2>Richteg Form (3 Optiounen)</h2>
      <div class="instruction-box">Wiel déi richteg konjugéiert Form.</div>
      <div class="row-center">
        <button class="secondary" id="g3Mix">Nei mixen</button>
        <div class="pill" id="g3Prog">1 / …</div>
      </div>
      <div class="big-box" id="g3Box">
        <div class="promptLine" id="g3Prompt">spillen, du</div>
        <div class="choices" id="g3Choices"></div>
      </div>
      <div class="feedback" id="g3Fb"></div>
    </section>

    <!-- G5: Fill red cells (each verb once, then auto next game) -->
    <section class="game" id="g5">
      <h2>Fëll d’rout Felder</h2>
      <div class="instruction-box">Fëll just: du / hien-hatt / dir. Klick “Kontrolléieren”. (All Verb kënnt just eemol.)</div>
      <div class="row-center">
        <button class="secondary" id="g5NextVerb">Nächst Verb</button>
        <button class="primary" id="g5Check">Kontrolléieren</button>
        <div class="pill" id="g5VerbLabel">fueren</div>
        <div class="pill" id="g5Prog">1 / …</div>
      </div>

      <table>
        <thead>
          <tr><th>Persoun</th><th>Form</th></tr>
        </thead>
        <tbody id="g5Body"></tbody>
      </table>
      <div class="feedback" id="g5Fb"></div>
    </section>

    <!-- G6: Race -->
    <section class="game" id="g7">
      <h2>Konjugatiouns-Race</h2>
      <div class="instruction-box">Soen et aus. Klick “Äntwert weisen” fir d’Léisung (wann néideg).</div>
      <div class="row-center">
        <button class="primary" id="g7Next">Nächst</button>
        <button class="secondary" id="g7Show">Äntwert weisen</button>
        <button class="secondary" id="g7Mix">Nei mixen</button>
      </div>

      <div class="big-box">
        <div class="promptLine" id="g7Prompt">spillen, du</div>
        <div class="feedback" id="g7Answer" style="font-size:2.0rem; margin-top:12px;"></div>
      </div>
    </section>

    <!-- G7: Fix the mistake -->
    <section class="game" id="g8">
      <h2>Feeler verbesseren</h2>
      <div class="instruction-box">Wiel déi richteg Form (dat anert ass falsch).</div>
      <div class="row-center">
        <button class="secondary" id="g8Mix">Nei mixen</button>
        <div class="pill" id="g8Prog">1 / …</div>
      </div>

      <div class="big-box" id="g8Box" style="font-size:1.9rem;">
        <div id="g8Sentence" style="margin-bottom:12px;"></div>
        <div class="choices" id="g8Choices"></div>
      </div>
      <div class="feedback" id="g8Fb"></div>
    </section>

    <!-- G8: Inversion with "gär" -->
    <section class="game" id="gInv">
      <h2>Inversioun – gär</h2>
      <div class="instruction-box">Zéi d’Wierder an déi richteg Reiefolleg (1–4) fir eng Fro ze bauen.</div>

      <div class="row-center">
        <button class="secondary" id="invReset">Reset</button>
        <button class="primary" id="invNext">Nächst Beispill</button>
        <div class="pill" id="invProg">1 / …</div>
      </div>

      <div class="drag-bank" id="invBank"></div>

      <div class="inv-zones">
        <div class="inv-slot" data-slot="1" id="invSlot1">1</div>
        <div class="inv-slot" data-slot="2" id="invSlot2">2</div>
        <div class="inv-slot" data-slot="3" id="invSlot3">3</div>
        <div class="inv-slot" data-slot="4" id="invSlot4">4</div>
      </div>

      <div class="feedback" id="invFeedback"></div>
    </section>

  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="modalTitle">Bravo!</h3>
      <p id="modalText">Alles fäerdeg.</p>
      <button class="primary" id="modalBtn">Weider</button>
    </div>
  </div>

<script>
/* ===================== CONJUGATION DATA ===================== */
const PERSONS = [
  {k:"ech", label:"ech"},
  {k:"du", label:"du"},
  {k:"hienhatt", label:"hien/hatt"},
  {k:"mir", label:"mir"},
  {k:"dir", label:"dir"},
  {k:"si", label:"si"}
];

// irregulars from your worksheet (explicit)
const IRREG_EXPLICIT = {
  "fueren":   { ech:"fueren", du:"fiers", hienhatt:"fiert", mir:"fueren", dir:"fuert", si:"fueren" },
  "danzen":   { ech:"danzen", du:"danz",  hienhatt:"danzt", mir:"danzen", dir:"danzt", si:"danzen" },
  "liesen":   { ech:"liesen", du:"lies",  hienhatt:"liest", mir:"liesen", dir:"liest", si:"liesen" },
  "schwammen":{ ech:"schwammen", du:"schwëmms", hienhatt:"schwëmmt", mir:"schwammen", dir:"schwammt", si:"schwammen" },
  "molen":    { ech:"molen", du:"mools", hienhatt:"moolt", mir:"molen", dir:"moolt", si:"molen" },
  "lafen":    { ech:"lafen", du:"leefs", hienhatt:"leeft", mir:"lafen", dir:"laaft", si:"lafen" },
  "maachen":  { ech:"maachen", du:"méchs", hienhatt:"mécht", mir:"maachen", dir:"maacht", si:"maachen" },
  "spillen":  { ech:"spillen", du:"spills", hienhatt:"spillt", mir:"spillen", dir:"spillt", si:"spillen" }
};

// regulars (conjugate like spillen)
const REGULAR = ["lauschteren","kucken","boxen","kachen","léieren","raschten","spadséieren","telefonéieren"];

function stemOf(inf){
  if(inf.endsWith("en")) return inf.slice(0,-2);
  return inf;
}
function conjRegular(inf){
  const st = stemOf(inf);
  return {
    ech: st + "en",
    du: st + "s",
    hienhatt: st + "t",
    mir: st + "en",
    dir: st + "t",
    si: st + "en"
  };
}

// Build master verbs list with forms
const VERBS = [];
Object.keys(IRREG_EXPLICIT).forEach(v=>{
  VERBS.push({inf:v, forms: IRREG_EXPLICIT[v], type: (v==="spillen") ? "regular" : "irregular"});
});
REGULAR.forEach(v=>{
  VERBS.push({inf:v, forms: conjRegular(v), type:"regular"});
});

// stem-change verbs
const STEM_CHANGE = new Set(["fueren","schwammen","molen","lafen","maachen"]); // danzen/liesen treated as ending-only

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function randInt(n){ return Math.floor(Math.random()*n); }
function pick(arr){ return arr[randInt(arr.length)]; }

function flash(el, cls){
  el.classList.remove("flash-green","flash-red");
  void el.offsetWidth;
  el.classList.add(cls);
}
function setFb(id, text, ok){
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = "feedback " + (ok ? "ok" : "bad");
}
function clearFb(id){
  const el = document.getElementById(id);
  el.textContent = "";
  el.className = "feedback";
}

/* ===================== MODAL ===================== */
const overlay = document.getElementById("overlay");
function showModal(title, text, onClick){
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalText").textContent = text;
  overlay.classList.add("show");
  document.getElementById("modalBtn").onclick = ()=>{
    overlay.classList.remove("show");
    onClick && onClick();
  };
}

/* ===================== NAV ===================== */
const gameEls = Array.from(document.querySelectorAll(".game"));
let gameIndex = 0;

function showGame(idx){
  gameEls.forEach((g,i)=>g.classList.toggle("active", i===idx));
  gameIndex = idx;
  document.getElementById("topTitle").textContent = "";

  // order:
  // 0 g1, 1 g9, 2 g2, 3 g3, 4 g5, 5 g7, 6 g8, 7 gInv
  if(idx===0) g1Render();
  if(idx===1) g9Render();
  if(idx===2) g2Render();
  if(idx===3) g3Render();
  if(idx===4) g5Render();
  if(idx===5) g7Render(true);
  if(idx===6) g8Render();
  if(idx===7) invRender();
}

document.getElementById("prevBtn").addEventListener("click", ()=>{
  showGame((gameIndex + gameEls.length - 1) % gameEls.length);
});
document.getElementById("nextBtn").addEventListener("click", ()=>{
  showGame((gameIndex + 1) % gameEls.length);
});

/* ===================== HELPERS ===================== */
function getVerb(inf){ return VERBS.find(v=>v.inf===inf); }
function correctForm(inf, personKey){
  const v = getVerb(inf);
  return v.forms[personKey];
}
function personLabel(k){
  return PERSONS.find(p=>p.k===k).label;
}
function promptText(inf, personKey){
  return `${inf}, ${personLabel(personKey)}`;
}

/* ===================== DECKS ===================== */
function buildPersonVerbDeck(){
  const deck=[];
  for(const v of VERBS){
    for(const p of PERSONS){
      deck.push({inf:v.inf, personKey:p.k});
    }
  }
  return shuffle(deck);
}

/* ===================== G1 Oral ===================== */
let g1Deck = buildPersonVerbDeck();
let g1Pos = 0;

function g1Render(){
  document.getElementById("g1Prog").textContent = `${g1Pos+1} / ${g1Deck.length}`;
  const item = g1Deck[g1Pos];
  document.getElementById("g1Prompt").textContent = promptText(item.inf, item.personKey);
}
document.getElementById("g1Next").addEventListener("click", ()=>{
  g1Pos++;
  if(g1Pos>=g1Deck.length){ g1Deck = buildPersonVerbDeck(); g1Pos=0; }
  g1Render();
});
document.getElementById("g1Mix").addEventListener("click", ()=>{
  g1Deck = buildPersonVerbDeck();
  g1Pos=0;
  g1Render();
});

/* ===================== COMMON WRONG FORM MAKERS ===================== */
function makeEndingMistake(form){
  if(form.endsWith("en")) return form.slice(0,-2) + "t";
  if(form.endsWith("t")) return form.slice(0,-1) + "en";
  if(form.endsWith("s")) return form.slice(0,-1) + "t";
  return form + "t";
}
function makeStemMistake(inf, personKey){
  const v = getVerb(inf);
  const correct = v.forms[personKey];

  if(STEM_CHANGE.has(inf) && (personKey==="du"||personKey==="hienhatt"||personKey==="dir")){
    const echForm = v.forms["ech"];
    const echStem = stemOf(echForm);
    const ending = personKey==="du" ? "s" : "t";
    return echStem + ending;
  }
  return makeEndingMistake(correct);
}

/* ===================== G9 Build from parts (stems improved) ===================== */
let g9Deck = buildPersonVerbDeck();
let g9Pos = 0;
let g9SelStem = null;
let g9SelEnd = null;

function splitStemEnd(inf, pk){
  const corr = correctForm(inf, pk);
  if(corr.endsWith("en")) return {stem: corr.slice(0,-2), end:"en"};
  if(corr.endsWith("s"))  return {stem: corr.slice(0,-1), end:"s"};
  if(corr.endsWith("t"))  return {stem: corr.slice(0,-1), end:"t"};
  return {stem: corr, end:""};
}
function uniqueKeepOrder(arr){
  const out = [];
  const seen = new Set();
  for(const x of arr){
    const k = String(x);
    if(!seen.has(k)){
      seen.add(k);
      out.push(k);
    }
  }
  return out;
}
function vowelSwap(stem){
  const swaps = [
    ["a","e"],["a","i"],["a","o"],["a","u"],
    ["e","a"],["e","i"],["e","o"],["e","u"],
    ["i","a"],["i","e"],["i","o"],["i","u"],
    ["o","a"],["o","e"],["o","i"],["o","u"],
    ["u","a"],["u","e"],["u","i"],["u","o"],
    ["ä","e"],["e","ä"],["ë","e"],["e","ë"]
  ];
  for(const [from,to] of swaps){
    if(stem.includes(from)) return stem.replace(from, to);
  }
  return null;
}
function vowelDouble(stem){
  const m = stem.match(/(ou|ei|ie|aa|ee|ii|oo|uu|ä|ë|a|e|i|o|u)/);
  if(!m) return null;
  const v = m[0];
  return stem.replace(v, v + v);
}
function makeImaginaryStems(baseStem, avoidSet, needCount){
  const fakes = [];
  const tries = [];

  const s1 = vowelSwap(baseStem);
  if(s1) tries.push(s1);

  const s2 = vowelDouble(baseStem);
  if(s2) tries.push(s2);

  if(s1){
    const s3 = vowelDouble(s1);
    if(s3) tries.push(s3);
  }

  tries.push(baseStem + "h");
  tries.push(baseStem + "n");

  for(const t of tries){
    const k = String(t);
    if(!avoidSet.has(k) && k.length >= 2){
      avoidSet.add(k);
      fakes.push(k);
      if(fakes.length >= needCount) break;
    }
  }
  return fakes;
}
function possibleRealStems(inf, pk){
  const v = getVerb(inf);
  const stemCorrect = splitStemEnd(inf, pk).stem;
  const stemInf     = stemOf(inf);
  const stemEch     = stemOf(v.forms.ech);
  const stemDu      = stemOf(v.forms.du);
  const stemHien    = stemOf(v.forms.hienhatt);
  const stemDir     = stemOf(v.forms.dir);
  return uniqueKeepOrder([stemCorrect, stemInf, stemEch, stemDu, stemHien, stemDir]);
}
function buildStemOptions(inf, pk, targetCount=4){
  const real = possibleRealStems(inf, pk);
  const avoid = new Set(real);
  let stems = real.slice(0);

  if(stems.length < targetCount){
    const base = stems[0] || stemOf(inf) || inf;
    const fakes = makeImaginaryStems(base, avoid, targetCount - stems.length);
    stems = stems.concat(fakes);
  }

  const correctStem = splitStemEnd(inf, pk).stem;
  if(!stems.includes(correctStem)){
    stems.unshift(correctStem);
    stems = uniqueKeepOrder(stems);
  }

  stems = uniqueKeepOrder(stems).slice(0, targetCount);
  stems = shuffle(stems);

  if(!stems.includes(correctStem)){
    stems[0] = correctStem;
  }
  return stems;
}

function g9Render(){
  clearFb("g9Fb");
  g9SelStem = null; g9SelEnd = null;
  document.getElementById("g9Result").textContent = "—";

  const item = g9Deck[g9Pos];
  document.getElementById("g9Prog").textContent = `${g9Pos+1} / ${g9Deck.length}`;
  document.getElementById("g9Prompt").textContent = promptText(item.inf, item.personKey);

  const corr = correctForm(item.inf, item.personKey);
  const parts = splitStemEnd(item.inf, item.personKey);

  const stems = buildStemOptions(item.inf, item.personKey, 4);

  let ends = shuffle(Array.from(new Set([parts.end, "en", "t", "s", ""]))).slice(0,4);
  if(!ends.includes(parts.end)) ends[0]=parts.end;

  const stemWrap = document.getElementById("g9Stems");
  const endWrap = document.getElementById("g9Ends");
  stemWrap.innerHTML = "";
  endWrap.innerHTML = "";

  function updateResult(){
    if(g9SelStem===null || g9SelEnd===null) return;
    document.getElementById("g9Result").textContent = g9SelStem + g9SelEnd;
  }

  stems.forEach(s=>{
    const t = document.createElement("div");
    t.className = "tile";
    t.textContent = s;
    t.onclick = ()=>{
      Array.from(stemWrap.querySelectorAll(".tile")).forEach(x=>x.classList.remove("selected"));
      t.classList.add("selected");
      g9SelStem = s;
      updateResult();
    };
    stemWrap.appendChild(t);
  });

  ends.forEach(e=>{
    const t = document.createElement("div");
    t.className = "tile";
    t.textContent = e==="" ? "∅" : ("-" + e);
    t.dataset.end = e;
    t.onclick = ()=>{
      Array.from(endWrap.querySelectorAll(".tile")).forEach(x=>x.classList.remove("selected"));
      t.classList.add("selected");
      g9SelEnd = e;
      updateResult();
    };
    endWrap.appendChild(t);
  });

  document.getElementById("g9Check").onclick = ()=>{
    if(g9SelStem===null || g9SelEnd===null){
      setFb("g9Fb","Wiel e Stamm an eng Endung.", false);
      return;
    }
    const attempt = g9SelStem + g9SelEnd;
    const ok = attempt === corr;
    setFb("g9Fb", ok ? "Richteg!" : `Nee. Richteg ass: ${corr}`, ok);
    setTimeout(()=>{
      g9Pos=(g9Pos+1)%g9Deck.length;
      g9Render();
    }, ok ? 650 : 1100);
  };
}
document.getElementById("g9Mix").addEventListener("click", ()=>{
  g9Deck = buildPersonVerbDeck();
  g9Pos=0;
  g9Render();
});

/* ===================== G2 Change type ===================== */
let g2Deck = buildPersonVerbDeck();
let g2Pos = 0;

function changeTypeComparedToInf(inf, personKey){
  const corr = correctForm(inf, personKey);
  if(corr === inf) return "näischt";

  const infStem = stemOf(inf);
  const infEnd = inf.endsWith("en") ? "en" : "";

  const corrParts = splitStemEnd(inf, personKey);
  const corrStem = corrParts.stem;
  const corrEnd = corrParts.end;

  const stemChanged = corrStem !== infStem;
  const endChanged  = corrEnd !== infEnd;

  if(stemChanged && endChanged) return "beides";
  if(stemChanged) return "stamm";
  if(endChanged)  return "endung";
  return "näischt";
}

function g2Render(){
  clearFb("g2Fb");
  const item = g2Deck[g2Pos];
  document.getElementById("g2Prog").textContent = `${g2Pos+1} / ${g2Deck.length}`;

  const corr = correctForm(item.inf, item.personKey);
  document.getElementById("g2Prompt").textContent = `${item.inf} → ${corr}`;

  const expected = changeTypeComparedToInf(item.inf, item.personKey);

  function answer(choice){
    const ok = choice===expected;
    flash(document.getElementById("g2Box"), ok ? "flash-green" : "flash-red");
    setFb("g2Fb", ok ? "Richteg!" : "Nee.", ok);
    setTimeout(()=>{ g2Pos = (g2Pos+1)%g2Deck.length; g2Render(); }, 520);
  }

  document.getElementById("g2Stem").onclick = ()=>answer("stamm");
  document.getElementById("g2End").onclick  = ()=>answer("endung");
  document.getElementById("g2None").onclick = ()=>answer("näischt");
  document.getElementById("g2Both").onclick = ()=>answer("beides");
}
document.getElementById("g2Mix").addEventListener("click", ()=>{
  g2Deck = buildPersonVerbDeck();
  g2Pos=0;
  g2Render();
});

/* ===================== G3 MCQ ===================== */
let g3Deck = buildPersonVerbDeck();
let g3Pos = 0;

function g3Render(){
  clearFb("g3Fb");
  const item = g3Deck[g3Pos];
  document.getElementById("g3Prog").textContent = `${g3Pos+1} / ${g3Deck.length}`;
  document.getElementById("g3Prompt").textContent = promptText(item.inf, item.personKey);

  const correct = correctForm(item.inf, item.personKey);

  let d1 = makeEndingMistake(correct);
  let d2 = makeStemMistake(item.inf, item.personKey);

  const seen = new Set([correct]);
  if(seen.has(d1)) d1 = d1 + " ";
  seen.add(d1);
  if(seen.has(d2)) d2 = d2 + " ";
  const options = shuffle([correct, d1, d2]);

  const wrap = document.getElementById("g3Choices");
  wrap.innerHTML = "";
  options.forEach(opt=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = opt;
    btn.onclick = ()=>{
      const ok = opt===correct;
      flash(document.getElementById("g3Box"), ok ? "flash-green" : "flash-red");
      setFb("g3Fb", ok ? "Richteg!" : "Nee.", ok);
      setTimeout(()=>{ g3Pos=(g3Pos+1)%g3Deck.length; g3Render(); }, 620);
    };
    wrap.appendChild(btn);
  });
}
document.getElementById("g3Mix").addEventListener("click", ()=>{
  g3Deck = buildPersonVerbDeck();
  g3Pos=0;
  g3Render();
});

/* ===================== G5 Fill red cells (each verb once) ===================== */
let g5VerbDeck = shuffle(VERBS.map(v=>v.inf));
let g5VerbPos = 0;
let g5Verb = g5VerbDeck[g5VerbPos];

function g5UpdateProg(){
  document.getElementById("g5Prog").textContent = `${g5VerbPos+1} / ${g5VerbDeck.length}`;
}

function g5Render(){
  clearFb("g5Fb");
  g5Verb = g5VerbDeck[g5VerbPos];
  document.getElementById("g5VerbLabel").textContent = g5Verb;
  g5UpdateProg();

  const v = getVerb(g5Verb);
  const body = document.getElementById("g5Body");
  body.innerHTML = "";

  const order = ["ech","du","hienhatt","mir","dir","si"];
  order.forEach(pk=>{
    const tr = document.createElement("tr");
    const tdP = document.createElement("td");
    tdP.textContent = personLabel(pk);
    const tdF = document.createElement("td");

    if(pk==="du" || pk==="hienhatt" || pk==="dir"){
      tdF.className = "cell-red";
      const sel = document.createElement("select");
      sel.dataset.pk = pk;

      const corr = v.forms[pk];
      const wrong1 = makeEndingMistake(corr);
      const wrong2 = makeStemMistake(v.inf, pk);
      const opts = shuffle([corr, wrong1, wrong2]).map(x=>String(x));

      opts.forEach(o=>{
        const op = document.createElement("option");
        op.value = o;
        op.textContent = o;
        sel.appendChild(op);
      });

      tdF.appendChild(sel);
    }else{
      tdF.className = "cell-green";
      tdF.textContent = v.forms[pk];
    }

    tr.appendChild(tdP);
    tr.appendChild(tdF);
    body.appendChild(tr);
  });
}

function g5AdvanceOrFinish(){
  g5VerbPos++;
  if(g5VerbPos >= g5VerbDeck.length){
    showModal("Bravo!", "Du hues all Verben am Spill gemaach!", ()=>{
      showGame((gameIndex + 1) % gameEls.length);
    });
    return;
  }
  g5Render();
}

document.getElementById("g5Check").addEventListener("click", ()=>{
  const v = getVerb(g5Verb);
  const selects = Array.from(document.querySelectorAll("#g5Body select"));
  let okCount = 0;
  selects.forEach(sel=>{
    const pk = sel.dataset.pk;
    const ok = sel.value === v.forms[pk];
    sel.style.outline = ok ? "3px solid rgba(17,122,58,.35)" : "3px solid rgba(176,35,35,.35)";
    okCount += ok ? 1 : 0;
  });

  if(okCount===3){
    setFb("g5Fb","Alles richteg!", true);
    setTimeout(()=>{ g5AdvanceOrFinish(); }, 700);
  }else{
    setFb("g5Fb","Nach net ganz. Probéier nach eng Kéier.", false);
  }
});
document.getElementById("g5NextVerb").addEventListener("click", ()=>{
  g5AdvanceOrFinish();
});

/* ===================== G7 Race ===================== */
let g7Deck = buildPersonVerbDeck();
let g7Pos = 0;

function g7Render(resetAnswer){
  if(resetAnswer){
    document.getElementById("g7Answer").textContent = "";
    document.getElementById("g7Answer").className="feedback";
  }
  const item = g7Deck[g7Pos];
  document.getElementById("g7Prompt").textContent = promptText(item.inf, item.personKey);
}
document.getElementById("g7Next").addEventListener("click", ()=>{
  g7Pos++;
  if(g7Pos>=g7Deck.length){ g7Deck = buildPersonVerbDeck(); g7Pos=0; }
  g7Render(true);
});
document.getElementById("g7Mix").addEventListener("click", ()=>{
  g7Deck = buildPersonVerbDeck(); g7Pos=0; g7Render(true);
});
document.getElementById("g7Show").addEventListener("click", ()=>{
  const item = g7Deck[g7Pos];
  document.getElementById("g7Answer").textContent = correctForm(item.inf, item.personKey);
  document.getElementById("g7Answer").className = "feedback ok";
});

/* ===================== G8 Fix mistake ===================== */
let g8Deck = buildPersonVerbDeck();
let g8Pos = 0;

function makeWrongForm(inf, pk){
  const corr = correctForm(inf, pk);
  const wrongA = makeEndingMistake(corr);
  const wrongB = makeStemMistake(inf, pk);
  return shuffle([wrongA, wrongB])[0];
}

function g8Render(){
  clearFb("g8Fb");
  const item = g8Deck[g8Pos];
  document.getElementById("g8Prog").textContent = `${g8Pos+1} / ${g8Deck.length}`;

  const pLab = personLabel(item.personKey);
  const corr = correctForm(item.inf, item.personKey);
  const wrong = makeWrongForm(item.inf, item.personKey);

  document.getElementById("g8Sentence").textContent = `${pLab} ${wrong}.`;

  const choices = shuffle([corr, wrong]);
  const wrap = document.getElementById("g8Choices");
  wrap.innerHTML = "";
  choices.forEach(opt=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = `${pLab} ${opt}.`;
    btn.onclick = ()=>{
      const ok = opt===corr;
      flash(document.getElementById("g8Box"), ok ? "flash-green" : "flash-red");
      setFb("g8Fb", ok ? "Richteg!" : "Nee.", ok);
      setTimeout(()=>{ g8Pos=(g8Pos+1)%g8Deck.length; g8Render(); }, 750);
    };
    wrap.appendChild(btn);
  });
}
document.getElementById("g8Mix").addEventListener("click", ()=>{
  g8Deck = buildPersonVerbDeck();
  g8Pos=0;
  g8Render();
});

/* ===================== Inversion – gär ===================== */
/*
Slots:
1 = Verb (conjugated)
2 = Person (du/hien/hatt/dir)
3 = gär (net gär becomes gär when dropped)
4 = Information (optional)
*/

const INV_PERSONS = ["du","hien","hatt","dir"];
const INV_EXAMPLES = [
  { verb:"schwammen", info:null },
  { verb:"spillen", info:"Fussball" },
  { verb:"liesen", info:null },
  { verb:"kucken", info:"Tëlee" },
  { verb:"danzen", info:null },
  { verb:"lauschteren", info:"Musek" }
];

let invOrder = shuffle(INV_EXAMPLES);
let invPos = 0;

let invChosen = null;
let invState = { verbInf:null, person:null, gar:null, info:null };

function invSetSlot(slotEl, type, text){
  slotEl.classList.add("filled");
  slotEl.innerHTML = `<span class="inv-chip ${type}">${text}</span>`;
}
function invResetSlots(){
  invState = { verbInf:null, person:null, gar:null, info:null };
  ["invSlot1","invSlot2","invSlot3","invSlot4"].forEach((id)=>{
    const el = document.getElementById(id);
    el.classList.remove("filled","over","flash-green","flash-red");
    el.textContent = el.dataset.slot;
    el.dataset.type = "";
  });
  clearFb("invFeedback");
}

function invMakeTile(text, cls, type){
  const d = document.createElement("div");
  d.className = `drag ${cls}`;
  d.textContent = text;
  d.draggable = true;
  d.dataset.type = type;
  d.dataset.value = text;
  d.addEventListener("dragstart", (e)=>{
    e.dataTransfer.setData("text/plain", JSON.stringify({type, value:text}));
  });
  return d;
}

function invConjugate(inf, personLabel){
  // use existing data where possible, with mapping person->personKey
  const mapPersonKey = { "du":"du", "hien":"hienhatt", "hatt":"hienhatt", "dir":"dir" };

  // if verb exists in VERBS list:
  const v = getVerb(inf);
  if(v){
    const pk = mapPersonKey[personLabel];
    return v.forms[pk];
  }

  // fallback (shouldn't happen)
  return inf;
}

function invLoad(){
  invChosen = invOrder[invPos];
  document.getElementById("invProg").textContent = `${invPos+1} / ${invOrder.length}`;

  const bank = document.getElementById("invBank");
  bank.innerHTML = "";
  invResetSlots();

  // Tiles (top bank)
  bank.appendChild(invMakeTile(invChosen.verb, "verb", "verb"));
  INV_PERSONS.forEach(p=> bank.appendChild(invMakeTile(p, "person", "person")));
  bank.appendChild(invMakeTile("gär", "gar", "gar"));
  bank.appendChild(invMakeTile("net gär", "gar", "gar"));
  if(invChosen.info) bank.appendChild(invMakeTile(invChosen.info, "info", "info"));
}

function invTryUpdateConjugatedVerb(){
  // If verb + person are both set, update slot1 with conjugated form
  if(invState.verbInf && invState.person){
    const slot1 = document.getElementById("invSlot1");
    const conj = invConjugate(invState.verbInf, invState.person);
    invSetSlot(slot1, "verb", conj);
    slot1.dataset.type = "verb";
  }
}

function invCheck(){
  // must have verb, person, gar. info required only if example has it.
  if(!invState.verbInf || !invState.person || !invState.gar) return;
  if(invChosen.info && !invState.info) return;

  // verify verb in slot1 is correct conjugation
  const conj = invConjugate(invState.verbInf, invState.person);

  const slot1Text = document.getElementById("invSlot1").textContent.trim();
  const slot2Text = document.getElementById("invSlot2").textContent.trim();
  const slot3Text = document.getElementById("invSlot3").textContent.trim();
  const slot4Text = document.getElementById("invSlot4").textContent.trim();

  const okVerb = slot1Text === conj;
  const okPerson = slot2Text === invState.person;
  const okGar = slot3Text === "gär";
  const okInfo = !invChosen.info || slot4Text === invChosen.info;

  const ok = okVerb && okPerson && okGar && okInfo;

  const slots = [document.getElementById("invSlot1"),document.getElementById("invSlot2"),document.getElementById("invSlot3"),document.getElementById("invSlot4")];
  slots.forEach(s=>{
    s.classList.remove("flash-green","flash-red");
    void s.offsetWidth;
    s.classList.add(ok ? "flash-green" : "flash-red");
  });

  setFb("invFeedback", ok ? "Richteg!" : "Nach eng Kéier.", ok);

  if(ok){
    setTimeout(()=>{
      invPos++;
      if(invPos >= invOrder.length){
        showModal("Bravo!", "Alles fäerdeg!", ()=>{
          invOrder = shuffle(INV_EXAMPLES);
          invPos = 0;
          invLoad();
        });
      }else{
        invLoad();
      }
    }, 750);
  }
}

function invWireSlots(){
  document.querySelectorAll(".inv-slot").forEach(slot=>{
    slot.addEventListener("dragover", (e)=>{ e.preventDefault(); slot.classList.add("over"); });
    slot.addEventListener("dragleave", ()=> slot.classList.remove("over"));
    slot.addEventListener("drop", (e)=>{
      e.preventDefault();
      slot.classList.remove("over");

      const data = JSON.parse(e.dataTransfer.getData("text/plain"));
      const sNum = slot.dataset.slot;

      // basic slot-type expectations:
      // 1 verb, 2 person, 3 gar, 4 info (optional)
      if(sNum==="1" && data.type!=="verb"){ flash(slot,"flash-red"); return; }
      if(sNum==="2" && data.type!=="person"){ flash(slot,"flash-red"); return; }
      if(sNum==="3" && data.type!=="gar"){ flash(slot,"flash-red"); return; }
      if(sNum==="4" && data.type!=="info"){ flash(slot,"flash-red"); return; }

      // Place
      if(sNum==="1"){
        invState.verbInf = data.value;
        invSetSlot(slot, "verb", data.value); // will be updated after person drop
        slot.dataset.type = "verb";
        invTryUpdateConjugatedVerb();
      }
      if(sNum==="2"){
        invState.person = data.value;
        invSetSlot(slot, "person", data.value);
        slot.dataset.type = "person";
        invTryUpdateConjugatedVerb();
      }
      if(sNum==="3"){
        invState.gar = "gär";
        invSetSlot(slot, "gar", "gär"); // always gär
        slot.dataset.type = "gar";
      }
      if(sNum==="4"){
        invState.info = data.value;
        invSetSlot(slot, "info", data.value);
        slot.dataset.type = "info";
      }

      invCheck();
    });
  });
}

function invRender(){
  // ensure wired once
  if(!window.__invWired){
    invWireSlots();
    window.__invWired = true;
  }
  invLoad();
}

document.getElementById("invReset").addEventListener("click", ()=>{
  invLoad();
});
document.getElementById("invNext").addEventListener("click", ()=>{
  invPos++;
  if(invPos >= invOrder.length){
    invOrder = shuffle(INV_EXAMPLES);
    invPos = 0;
  }
  invLoad();
});

/* ===================== INIT ===================== */
showGame(0);
</script>
</body>
</html>



